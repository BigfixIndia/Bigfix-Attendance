{% extends 'layouts/base.html' %}
{% block content %}

<div class="row">
    <!-- Employee Profile Card -->
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-user me-2"></i>Employee Profile</h5>
            </div>
            <div class="card-body text-center">
                <form method="post" enctype="multipart/form-data" action="{% url 'change_profile_picture' %}">
                    {% csrf_token %}
                    <div class="position-relative d-inline-block mb-3">
                        {% if employee.profile_pic %}
                            <img src="{{ employee.profile_pic.url }}?{% now 'U' %}" alt="Profile Picture" class="rounded-circle" style="width: 120px; height: 120px; object-fit: cover;">
                        {% else %}
                            <div class="bg-light rounded-circle d-inline-flex align-items-center justify-content-center" style="width: 120px; height: 120px;">
                                <i class="fas fa-user fa-4x text-secondary"></i>
                            </div>
                        {% endif %}
                        <label for="id_profile_pic" class="position-absolute bottom-0 end-0 bg-primary text-white rounded-circle p-1" style="cursor: pointer;">
                            <i class="fas fa-edit"></i>
                        </label>
                        <input type="file" name="profile_pic" id="id_profile_pic" style="display: none;" accept="image/jpeg,image/png,image/gif" onchange="this.form.submit();">
                    </div>
                    {% if form.errors.profile_pic %}
                        <div class="text-danger mb-2">
                            {% for error in form.errors.profile_pic %}
                                {{ error }}<br>
                            {% endfor %}
                        </div>
                    {% endif %}
                </form>

                <div class="mb-3">
                    <a href="{% url 'download_id_card' %}" class="btn btn-sm btn-primary" title="Download ID Card">
                        <i class="fas fa-download"></i>
                    </a>
                </div>

                <h5>{{ employee.user.first_name }} {{ employee.user.last_name }}</h5>
                <p class="text-muted mb-2">{{ employee.position|default:"Not set" }}</p>
                <p class="badge bg-primary">{{ employee.department|default:"Not set" }}</p>

                <hr>
                <div class="text-start">
                    <p><strong><i class="fas fa-id-card me-2"></i>Employee ID:</strong> {{ employee.employee_id|default:"Not set" }}</p>
                    <p><strong><i class="fas fa-envelope me-2"></i>Email:</strong> {{ employee.user.email|default:"Not set" }}</p>
                    <p><strong><i class="fas fa-phone me-2"></i>Phone:</strong> {{ employee.phone_number|default:"Not set" }}</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Dashboard -->
    <div class="col-md-8">
        <div class="card-body">
            {% if messages %}
                <div class="mb-3">
                    {% for message in messages %}
                        <div class="alert {% if message.tags == 'success' %}alert-success{% elif message.tags == 'error' %}alert-danger{% else %}alert-warning{% endif %} alert-dismissible fade show" role="alert" data-auto-dismiss="3000">
                            {{ message }}
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        </div>
                    {% endfor %}
                </div>
            {% endif %}

            <p><strong>Selected Shift:</strong> {{ shift_display }}</p>

            {% if not has_checked_in %}
                <form method="post" action="{% url 'dashboard' %}">
                    {% csrf_token %}
                    <input type="hidden" name="set_shift" value="true">
                    <label><strong>Select Shift:</strong></label>
                    <select name="shift_type" class="form-control" required>
                        <option value="general">General</option>
                        <option value="morning">Morning</option>
                        <option value="evening">Evening</option>
                        <option value="both">Both</option>
                    </select>
                    <button type="submit" class="btn btn-sm btn-primary mt-2">Set Shift</button>
                </form>
            {% endif %}

            {% if has_checked_in %}
                <div class="alert alert-success mt-3">
                    <i class="fas fa-check-circle me-2"></i>
                    You have checked in at {{ mark_attendance.check_in_time|time:"h:i A" }}
                </div>

                {% if show_report_form %}
                    <!-- Show Report Buttons -->
                    <div class="d-flex justify-content-center gap-3 mt-4">
                        <button class="btn btn-outline-primary" onclick="toggleReportForm('hourly')">ðŸ•’ Hourly Report</button>
                        <button class="btn btn-outline-success" onclick="toggleReportForm('section')">ðŸ“‚ Section Report</button>
                    </div>

                      <!-- Hourly Report Form -->
    <div id="hourlyReportForm" class="card mt-4 d-none">
        <div class="card-header bg-primary text-white">
            <strong>ðŸ•’ Submit Hourly Report</strong>
        </div>
        <div class="card-body">
            <form method="post">
                {% csrf_token %}
                <div id="hourlyInputs">
                    <div class="row mb-2 hourly-group">
                        <div class="col-md-4">
                            <input type="text" name="hour_time[]" class="form-control" placeholder="e.g. 12pm - 1pm">
                        </div>
                        <div class="col-md-12 mt-4">
                            <textarea name="hour_report[]" class="form-control" placeholder="Worked on task" maxlength="200" oninput="updateCharCount(this)"></textarea>
                             <small class="text-muted">200 characters remaining</small>                        
                        </div>
                    </div>
                </div>
                <div class="d-flex gap-2">
                    <button type="button" class="btn btn-sm btn-secondary" onclick="addHourlyRow()">
                        âž• Add Row
                    </button>
                    <button type="submit" name="submit_hourly" class="btn btn-sm btn-primary">
                        Submit Hourly Report
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Section Report Form -->
    <div id="sectionReportForm" class="card mt-4 d-none">
        <div class="card-header bg-success text-white">
            <strong>ðŸ“‚ Submit Section Report</strong>
        </div>
        <div class="card-body">
            <form method="post">
                {% csrf_token %}
                <div id="sectionInputs">
                    <div class="mb-2 section-group">
                        <input type="text" name="section_title[]" class="form-control mb-1" placeholder="Section Title">
                       <textarea id="section_content" name="section_content[]" class="form-control" placeholder="Details" maxlength="200" oninput="updateCharCount(this)"></textarea>
                       <small id="charCount">200 characters remaining</small>
                    </div>
                    <div id="section-container">
                    
                    </div>
                </div>
                <div class="d-flex gap-2">
                    <button type="button" class="btn btn-sm btn-secondary" onclick="addSectionRow()">
                        âž• Add Section
                    </button>
                    <button type="submit" name="submit_section" class="btn btn-sm btn-success">
                        Submit Section Report
                    </button>
                </div>
            </form>
        </div>
    </div>
    {% endif %}

                <!-- Display Today's Submitted Reports -->
                {% if today_section_reports or today_hourly_reports %}
                    <div class="card mt-3">
                        <div class="card-header bg-info text-white"><strong>ðŸ“„ Today's Submitted Reports</strong></div>
                        <div class="card-body">
                            {% if today_section_reports %}
                                <h6 class="text-success">ðŸ“‚ Section Reports:</h6>
                                {% for report in today_section_reports %}
                                    <p><strong>{{ report.section_title }}:</strong> {{ report.report_text }}</p>
                                {% endfor %}
                            {% endif %}
                            {% if today_hourly_reports %}
                                <h6 class="text-primary">ðŸ•’ Hourly Reports:</h6>
                                {% for report in today_hourly_reports %}
                                    <p><strong>{{ report.hour_slot }}:</strong> {{ report.task_summary }}</p>
                                {% endfor %}
                            {% endif %}
                        </div>
                    </div>

                    <!-- Show Check-Out Button -->
                    <div class="alert alert-info mt-3">
                        âœ… Report Submitted! Now you can check out.
                    </div>
                    <a href="{% url 'scan_qr_code' %}" class="btn btn-primary mt-2">
                        <i class="fas fa-sign-out-alt me-2"></i>Check Out
                    </a>
                {% endif %}

                {% if has_checked_out %}
                    <div class="alert alert-secondary mt-4">
                        <i class="fas fa-sign-out-alt me-2"></i>
                        You have checked out at {{ mark_attendance.check_out_time|time:"h:i A" }}<br>
                        <strong>Working Hours:</strong> {{ working_hours_display }}
                    </div>
                {% endif %}
            {% else %}
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    You haven't checked in yet.
                </div>
                {% if shift_display != "Not Set" %}
                    <a href="{% url 'scan_qr_code' %}" class="btn btn-success mt-2">
                        <i class="fas fa-sign-in-alt me-2"></i>Check In
                    </a>
                {% else %}
                    <button class="btn btn-secondary mt-2" disabled>Please select a shift before checking in</button>
                {% endif %}
            {% endif %}

            <!-- Announcements Section -->
            <div class="card mt-4 shadow-sm">
                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">ðŸ“¢ Announcements</h5>
                    {% if unread_count %}
                        <span class="badge bg-warning text-dark">{{ unread_count }} New</span>
                    {% endif %}
                </div>
                <div class="card-body">
                    {% if announcements %}
                        <ul class="list-group list-group-flush">
                            {% for announcement in announcements %}
                                <li class="list-group-item">
                                    <div class="d-flex justify-content-between">
                                        <strong>{{ announcement.title }}</strong>
                                        {% if not announcement.is_read %}
                                            <span class="badge bg-success">New</span>
                                        {% endif %}
                                    </div>
                                    <small class="text-muted">{{ announcement.created_at|date:"M d, Y h:i A" }}</small>
                                    <p class="mb-0">{{ announcement.message }}</p>
                                </li>
                            {% endfor %}
                        </ul>
                    {% else %}
                        <p class="text-muted">No announcements at the moment.</p>
                    {% endif %}
                </div>
            </div>

            <!-- Past Reports Section -->
            <div class="card mt-4">
                <div class="card-header bg-secondary text-white">
                    <strong>ðŸ“‘ Past Reports</strong>
                </div>
                <div class="card-body">
                    {% if past_section_reports or past_hourly_reports %}
                        <select class="form-select mb-3" onchange="toggleReportDisplay(this.value)">
                            <option value="">-- Select Date --</option>
                            {% for report in past_section_reports %}
                                <option value="section_report_{{ report.id }}">{{ report.attendance.date|date:"M d, Y" }} - Section</option>
                            {% endfor %}
                            {% for report in past_hourly_reports %}
                                <option value="hourly_report_{{ report.id }}">{{ report.attendance.date|date:"M d, Y" }} - Hourly</option>
                            {% endfor %}
                        </select>

                        {% for report in past_section_reports %}
                            <div class="report-text alert alert-light border" id="section_report_{{ report.id }}" style="display: none;">
                                <strong>Date:</strong> {{ report.attendance.date|date:"M d, Y" }}<br>
                                <strong>Section Report:</strong><br>
                                <p><strong>{{ report.section_title }}:</strong> {{ report.report_text }}</p>
                            </div>
                        {% endfor %}
                        {% for report in past_hourly_reports %}
                            <div class="report-text alert alert-light border" id="hourly_report_{{ report.id }}" style="display: none;">
                                <strong>Date:</strong> {{ report.attendance.date|date:"M d, Y" }}<br>
                                <strong>Hourly Report:</strong><br>
                                <p><strong>{{ report.hour_slot }}:</strong> {{ report.task_summary }}</p>
                            </div>
                        {% endfor %}
                    {% else %}
                        <p class="text-muted">No past reports available.</p>
                    {% endif %}
                </div>
            </div>

        </div>
    </div>
</div>

<script>
function toggleReportForm(type) {
    document.getElementById('hourlyReportForm').classList.add('d-none');
    document.getElementById('sectionReportForm').classList.add('d-none');
    if (type === 'hourly') {
        document.getElementById('hourlyReportForm').classList.remove('d-none');
    } else if (type === 'section') {
        document.getElementById('sectionReportForm').classList.remove('d-none');
    }
}

function toggleReportDisplay(id) {
    document.querySelectorAll('.report-text').forEach(el => el.style.display = 'none');
    if (id && document.getElementById(id)) {
        document.getElementById(id).style.display = 'block';
    }
}

function addHourlyRow() {
    const container = document.getElementById('hourlyInputs');

    const group = document.createElement('div');
    group.className = 'row mb-2 hourly-group';

    // Unique ID for each textarea and its counter
    const uniqueId = `textarea-${Date.now()}`;

    group.innerHTML = `
        <div class="col-md-4 mt-3">
            <input type="text" name="hour_time[]" class="form-control" placeholder="e.g. 12pm - 1pm">
        </div>
        <div class="col-md-12 mt-4">
            <textarea id="${uniqueId}" name="hour_report[]" class="form-control" placeholder="Worked on task" maxlength="200"></textarea>
            <small class="text-muted" id="${uniqueId}-counter">200 characters remaining</small>
        </div>
    `;

    container.appendChild(group);

    // Add live character counter
    const textarea = document.getElementById(uniqueId);
    const counter = document.getElementById(`${uniqueId}-counter`);

    textarea.addEventListener("input", function () {
        const remaining = 200 - textarea.value.length;
        counter.textContent = `${remaining} characters remaining`;
    });
}


  function addSectionRow() {
  const container = document.getElementById("section-container");

  // Create wrapper div
  const wrapper = document.createElement("div");
  wrapper.className = "mb-2";

  // Create textarea
  const textarea = document.createElement("textarea");
  textarea.name = "section_content[]";
  textarea.className = "form-control";
  textarea.placeholder = "Details";
  textarea.maxLength = 200;

  // Create character counter
  const charCount = document.createElement("small");
  charCount.className = "text-muted";
  charCount.textContent = "200 characters remaining";

  // Attach input listener
  textarea.addEventListener("input", function () {
    const remaining = 200 - textarea.value.length;
    charCount.textContent = `${remaining} characters remaining`;
  });

  // Add elements to wrapper and container
  wrapper.appendChild(textarea);
  wrapper.appendChild(charCount);
  container.appendChild(wrapper);
}

//  for default text area

function updateCharCount(textarea) {
    const maxLength = textarea.maxLength;
    const currentLength = textarea.value.length;
    document.getElementById("charCount").textContent = 
      `${maxLength - currentLength} characters remaining`;
  }

  function updateCharCount(textarea) {
    const max = textarea.maxLength;
    const current = textarea.value.length;
    const remaining = max - current;

    // Find the <small> element right after the textarea
    const counter = textarea.nextElementSibling;
    if (counter && counter.tagName.toLowerCase() === 'small') {
        counter.textContent = `${remaining} characters remaining`;
    }
}
</script>
{% endblock %}